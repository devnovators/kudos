<link rel="import" href="kudos-list.html">
<dom-module id="kudos-demos">
  <style include="shared-styles">
    :host {
      display: block;

      padding: 2px;
    }
    
    .paper-header {
      height: 60px;
      font-size: 16px;
      line-height: 60px;
      padding: 0 10px;
      color: white;
      transition: height 0.2s;
      background-color: blue !important;
    }
    paper-card {
      width: 100%;
      margin:5px;
    }
    paper-card.rate { 
      @apply(--layout-horizontal); 
    }
    .rate-content {
      width: 100%;
      @apply(--layout-flex);
      float: left;
    }
    .rate-header { @apply(--paper-font-headline); }
    .rate-name { color: var(--paper-grey-600); margin: 10px 0; }
    paper-icon-button.rate-icon {
      --iron-icon-fill-color: white;
      --iron-icon-stroke-color: var(--paper-grey-600);
      cursor: pointer;
    }
    paper-icon-button.rate-icon:hover{
      background-color: yellow !important;
      color: blue;
    }
    paper-icon-button.rate-ico[active]{
    }
  </style>
  <template>
    <template id="resultList" is="dom-repeat" items="{{projects}}" as="project">
      <paper-card class="rate">
        <div class="rate-content">
          <div class="card-content">
            <div class="rate-header">{{project.name}}</div>
            <div class="rate-name">@{{project.team}}</div>
            <div>{{project.description}}</div>
            <input type="text" id="txtProject_{{project.id}}">
            <paper-icon-button class="rate-icon" id="{{project.id}}"
                  icon="announcement" 
                  on-tap="sendComment"></paper-icon-button>
          </div>
          <kudos-list project="{{project}}" _firebase="{{_firebase}}"></kudos-list>
      </paper-card>
    </template>
  </template>
</dom-module>
<script src="https://www.gstatic.com/firebasejs/3.0.4/firebase.js"></script>
<script>
  Polymer({
    is: 'kudos-demos',
    properties:{
      _firebase:Object,
      error:{
        type: Object,
        value:null,
        notify:true
      },
      userName: {
        type: String,
        notify:true
      },
      userUid: {
        type: String,
        notify:true
      },
      userPhoto: {
        type: String,
        notify:true
      },
      user: {
        type: Object,
        notify:true
      },
      projects:{
        type: Array,
        notify:true
      },
    },
    ready:function(){
      // Initialize Firebase
      var config = {
        apiKey: "AIzaSyBiBdm3MheV4sN7lfk0WLoVDtXXxHxbbvk",
        authDomain: "devnovators.firebaseapp.com",
        databaseURL: "https://devnovators.firebaseio.com",
        storageBucket: "devnovators.appspot.com",
      };
      firebase.initializeApp(config);
      this._firebase=firebase;
      firebase.auth().onAuthStateChanged(function(user) {
        console.log(user);
        if (user) {
           this.setearValor(user);
          //console.info('userName: ' + this.userName + ' - this.userUid'+ this.userUid + ' - userPhoto: ' + this.userPhoto );
          // User is signed in. //displayName - email - emailVerified - photoURL - isAnonymous -uid - providerData
        } else {
          // User is signed out.
          console.log("no hay nadie conectado");
        }
      });
      this.getProjects();
      //this.$.resultList.render();
    },
    setearValor:function(user){
          this.user=user;
          //console.info(user.displayName);
          this.userName=user.displayName;
          this.userPhoto=user.photoURL;
          this.userUid=user.uid;
    },
    getProjects:function(){
      var db = this._firebase.database();
      var ref = db.ref("/projects");
      var that = this;
      that.projects = [];
      ref.on("value", function(snapshot) {
        snapshot.forEach(function(child) {
          var project = child.val();
          project.id=child.key;
          that.push('projects', project);
        });
      });
      //ref.off();
    },
    sendComment:function(e){
      var project = Polymer.dom(e).localTarget;
      console.log(project.id);
      var idProject =project.id;
      var db = this._firebase.database();
      var ref = db.ref("/projects/" + idProject);
      var idTxt='#txtProject_'+ idProject;
      var msg=Polymer.dom(this.root).querySelector(idTxt).value;
      console.info(this.user);
      var postData = {
        //author: this.userName,
        message: msg
      };
      var newPostKey = ref.child('comments').push().key;
      var updates = {};
      updates["/comments/" + newPostKey] = postData;
      updates['/users/' + this.userName + '/' + newPostKey] = msg;
      ref.update(updates);
      Polymer.dom(this.root).querySelector(idTxt).value="";
    },
    attached: function() {
  this.user;
  // do something with childCount ...
}
  });
</script>

